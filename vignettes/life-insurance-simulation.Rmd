---
title: "Life Insurance Simulation"
author: "Andy Merlino"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

We provide life insurance.  

How much money do we need to set aside today so we can payout the entire life insurance benefit to all of our insurees?

```{r load_stuff}
library(insuree)
library(knitr) # for tables

options(scipen=999) # turn off scientific notation
```

Let's create some life insurance policies.

```{r create_policies, results = "asis"}
policies <- data.frame(id = c("A001", "A002", "A003", "A004", "A005", "A006"),
                       gender = c("male", "female", "female", "male", "male", "female"),
                       age = c(40, 51, 70, 45, 65, 35),
                       death_benefit = c(200000, 500000, 100000, 500000, 1000000, 2000000))

# format and print table
out <- policies
out$death_benefit <- format(out$death_benefit, big.mark = ",")
knitr::kable(out, align = c("l", "l", "r", "r"))
```

As you can see, we have male and female insurees of varying ages.  They also have varying death benefits.

We are going to create an object of class `insuree::Insuree` to represent each one of our insurees.  The future probability of death for each of these `insuree::Insuree` objects is defined by an actuarial life table.  We are using the official 2010 US social security life table as provided on the [Official Social Security Website](http://www.ssa.gov/oact/STATS/table4c6.html).  I named this life table `qx_table` and it comes with the package.

Here we define the `LifeTable` objects:

```{r life_tables}
# create male life table from qx_data (provided with the package)
qx_male <- insuree::LifeTable(x = c(qx_data$x, max(qx_data$x) + 1), 
                              q_x = c(qx_data$male_qx, NA)
                              )

# create female life table from qx_data (provided with the package)
qx_female <- insuree::LifeTable(x = c(qx_data$x, max(qx_data$x) + 1),
                                q_x = c(qx_data$female_qx, NA)
                                )
```

Now that we have male and female life tables lets assign each insuree to a `insuree::Insuree` object.  The `Insuree` object identifies the `LifeTable`, age, and
other policy characteristics appropriate to the individul policy.

```{r}
# I am finding the max age of the life tables so I can 
# make examples inwhich the Insuree's life insurance policy 
# lasts until the end of the life table.
max_m <- max(qx_male@x)
max_f <- max(qx_female@x)

# define each policy as an Insuree object
hold <- list()
for (j in 1:nrow(policies)) {
  hold[[j]] <- if (policies$gender[j] == "male") {
    insuree::Insuree(x_ = policies$age[j], 
                     t_ = max_m - policies$age[j],
                     benefit_t = max_m - policies$age[j],
                     benefit_value = policies$death_benefit[j],
                     qx_male)
  } else {
    insuree::Insuree(x_ = policies$age[j],
                     t_ = max_f - policies$age[j],
                     benefit_t = max_f - policies$age[j], 
                     benefit_value = policies$death_benefit[j],
                     qx_female)
  }
}
```

To run the simulation and discount to present value we need to decide how many simulations we want to run and our discount rate.

```{r}
# select number of times to run simulation
n <- 1000

# set discount rate
rate <- 0.04
```

Each element in our `hold` object is an object of class `Insuree`.  We can simulate the future life and present value of the benefits for any of these `Insuree` objects individually like so

```{r, results = "asis"}
quants <- seq(0.70, 0.95, by = 0.05)
# simulate individual Insuree
single <- rpv(hold[[1]], n = n, interest = rate)
total <- single$pv
quantiles <- quantile(total, quants)
sim_mean <- mean(total)

# make it look decent for printing
out <- data.frame("Risk Level" = c("mean", names(quantiles)),
                 "Value" = format(round(c(sim_mean, quantiles), 0), big.mark = ","))
knitr::kable(out, row.names = FALSE, align = c("l", "r"))
```

The package also comes with some built in plot options for `rpv()` on class `Insuree`.

```{r, fig.width = 7}
plot(single)
hist(single)
```

Simulating one life insurance policy is not that interesting.  The real power of the `insuree` package come when we group the policies together.  By simulating the group we can come up with confidence levels for the present value of future benefit payments that would otherwise be very difficult to calculate.

We run `r n` observations of each individual's future life expectancy.  We assume each individual future life expectancy is independent.  We discount the death benefit, assuming a `r rate * 100`% annual interest rate.

```{r, result = "asis"}
# create object of class "Pool"
pool <- Pool(insurees = hold)
# run simulation on each insuree
# we are only interested in the present value of the simulation here
pooled_rpv <- insuree::rpv(pool, n = n, interest = rate)
total <- apply(summary(pooled_rpv), 1, sum)
quantiles <- quantile(total, seq(0.70, 0.95, by = 0.05))
sim_mean <- mean(total)

# make it look decent for printing
out <- data.frame("Risk Level" = c("mean", names(quantiles)),
                 "Value" = format(c(sim_mean, quantiles), big.mark = ","))
knitr::kable(out, row.names = FALSE, align = c("l", "r"))
```

and we can make similar plots to those for the single `Insuree` object:

```{r, fig.width = 7}
plot(pooled_rpv)
hist(pooled_rpv)
```